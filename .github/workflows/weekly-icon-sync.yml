name: FluentUI Icons Sync

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no new icons found'
        required: false
        default: false
        type: boolean
      git_ref:
        description: 'Git reference: branch name (main) or tag name (1.1.305)'
        required: false
        default: 'main'
        type: string
      custom_branch:
        description: 'Custom branch name for PR'
        required: false
        default: ''
        type: string

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true
  JAVA_VERSION: '17'

jobs:
  sync-icons:
    runs-on: ubuntu-latest
    
    outputs:
      new_families_count: ${{ steps.check_icons.outputs.new_families_count }}
      new_variants_count: ${{ steps.check_icons.outputs.new_variants_count }}
      sync_performed: ${{ steps.sync_check.outputs.sync_performed }}
      pr_created: ${{ steps.create_pr.outputs.pull-request-number != '' }}
      git_ref_formatted: ${{ steps.setup_config.outputs.git_ref_formatted }}
      git_ref_display: ${{ steps.setup_config.outputs.git_ref_display }}
    
    steps:
    - name: ðŸ—ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“¦ Setup JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: gradle
    
    - name: ðŸ”§ Setup Gradle
      uses: gradle/gradle-build-action@v3
      with:
        gradle-home-cache-cleanup: true
    
    - name: âš™ï¸ Configure FluentUI plugin
      id: setup_config
      run: |
        input_ref="${{ github.event.inputs.git_ref || 'main' }}"
        
        # Format Git reference properly
        if [[ "$input_ref" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          # Version tag format: 1.1.305 -> refs/tags/1.1.305
          git_ref="refs/tags/$input_ref"
          ref_type="tag"
        elif [[ "$input_ref" == refs/* ]]; then
          # Already formatted reference
          git_ref="$input_ref"
          if [[ "$input_ref" == refs/tags/* ]]; then
            ref_type="tag"
          else
            ref_type="branch"
          fi
        else
          # Branch name: main -> refs/heads/main
          git_ref="refs/heads/$input_ref"
          ref_type="branch"
        fi
        
        echo "git_ref_formatted=$git_ref" >> $GITHUB_OUTPUT
        echo "git_ref_display=$input_ref" >> $GITHUB_OUTPUT
        echo "ref_type=$ref_type" >> $GITHUB_OUTPUT
        
        echo "GIT_REF_FORMATTED=$git_ref" >> $GITHUB_ENV
        
        echo "ðŸ”§ FluentUI Icons Plugin Configuration:"
        echo "ðŸ”— Mode: Git Repository (workflows always use Git cloning)"
        echo "ðŸ“ Repository: https://github.com/microsoft/fluentui-system-icons.git"
        echo "ðŸŒ¿ Reference: $git_ref ($ref_type)"
        echo "ðŸŽ¯ Plugin: fluent.icons"
    
    - name: ðŸ” Check for new icons
      id: check_icons
      run: |
        echo "ðŸ” Checking for new FluentUI icons..."
        echo "ðŸ”— Using git repository with reference: $GIT_REF_FORMATTED"
        
        # Plugin handles Git operations internally
        ./gradlew checkNewIcons \
          -PfluentIcons.gitRef="$GIT_REF_FORMATTED" \
          --console=plain > check_output.txt 2>&1
        
        # Extract counts from output
        new_families=$(grep -c "ðŸ“" check_output.txt || echo '0')
        new_variants=$(grep "Total variants to sync:" check_output.txt | grep -o '[0-9]\+' || echo '0')
        
        echo "new_families_count=$new_families" >> $GITHUB_OUTPUT
        echo "new_variants_count=$new_variants" >> $GITHUB_OUTPUT
        
        echo "ðŸ“Š Found: $new_families new families, $new_variants new variants"
        echo "ðŸ“‹ Full check output:"
        cat check_output.txt
        
        # Save output for later steps
        echo "CHECK_OUTPUT<<EOF" >> $GITHUB_ENV
        cat check_output.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
    
    - name: ðŸŽ¯ Determine if sync should proceed
      id: sync_check
      run: |
        should_sync="false"
        
        if [ "${{ steps.check_icons.outputs.new_variants_count }}" -gt "0" ]; then
          echo "âœ… New variants found, proceeding with sync"
          should_sync="true"
        elif [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
          echo "ðŸ”„ Force sync requested, proceeding anyway"
          should_sync="true"
        else
          echo "â„¹ï¸ No new variants found and force sync not requested"
          should_sync="false"
        fi
        
        echo "sync_performed=$should_sync" >> $GITHUB_OUTPUT
        echo "SHOULD_SYNC=$should_sync" >> $GITHUB_ENV
    
    - name: ðŸŽ¨ Sync and convert new icons
      if: env.SHOULD_SYNC == 'true'
      run: |
        echo "ðŸŽ¨ Starting FluentUI icon sync and conversion..."
        echo "ðŸ”„ Plugin will handle: Git clone â†’ SVG scan â†’ ImageVector conversion"
        
        # Plugin handles entire pipeline: Git operations + SVG conversion + file generation
        ./gradlew syncNewIcons \
          -PfluentIcons.gitRef="$GIT_REF_FORMATTED" \
          --console=plain
        
        echo "ðŸ“Š Sync completed, checking for changes..."
        if [[ `git status --porcelain` ]]; then
          echo "âœ… Changes detected after sync"
          git status --short
        else
          echo "âš ï¸ No changes detected after sync"
        fi
    
    - name: ðŸ“ˆ Analyze icon coverage
      if: env.SHOULD_SYNC == 'true'
      run: |
        echo "ðŸ“ˆ Running FluentUI icon coverage analysis..."
        
        ./gradlew analyzeIconCoverage \
          -PfluentIcons.gitRef="$GIT_REF_FORMATTED" \
          --console=plain > coverage_analysis.txt 2>&1
        
        echo "COVERAGE_ANALYSIS<<EOF" >> $GITHUB_ENV
        cat coverage_analysis.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "ðŸ“‹ Coverage analysis:"
        cat coverage_analysis.txt
    
    - name: ðŸ”§ Setup Git configuration
      if: env.SHOULD_SYNC == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: ðŸ“ Generate comprehensive commit message
      if: env.SHOULD_SYNC == 'true'
      id: commit_msg
      run: |
        timestamp=$(date -u +"%Y-%m-%d %H:%M UTC")
        families="${{ steps.check_icons.outputs.new_families_count }}"
        variants="${{ steps.check_icons.outputs.new_variants_count }}"
        git_ref="${{ steps.setup_config.outputs.git_ref_display }}"
        
        # Create detailed commit message
        cat > commit_message.txt << EOF
        ðŸŽ¨ FluentUI Icons Sync: Added $variants ImageVectors from $families families
        
        ðŸ“… Sync Date: $timestamp
        ðŸŒ¿ Source: microsoft/fluentui-system-icons@$git_ref
        
        ðŸ“Š Summary:
        - New icon families: $families
        - New style variants: $variants
        - Conversion: SVG â†’ ImageVector (Jetpack Compose)
        - Organization: Style-based directories (filled/, regular/, light/, color/)
        
        ðŸŽ¯ Changes:
        - SVGs auto-converted using svg2compose
        - Icons organized by style with proper naming
        - IconList files updated with new imports
        - Generated: FluentIcons.Style.IconName accessors
        
        ðŸ”§ Plugin: fluent.icons v2.0.0
        Generated by fluentui-icons-sync workflow
        EOF
        
        echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_ENV
        cat commit_message.txt >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
    
    - name: ðŸ”€ Create Pull Request
      if: env.SHOULD_SYNC == 'true'
      id: create_pr
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: ${{ env.COMMIT_MESSAGE }}
        title: "ðŸŽ¨ FluentUI Icons Sync - ${{ steps.check_icons.outputs.new_variants_count }} New ImageVectors"
        branch: ${{ github.event.inputs.custom_branch || format('fluentui-icons-sync-{0}', github.run_number) }}
        delete-branch: true
        body: |
          ## ðŸŽ¨ FluentUI Icons Sync Report
          
          **ðŸ“… Sync Date:** ${{ steps.commit_msg.outputs.timestamp }}  
          **ðŸŒ¿ Source:** microsoft/fluentui-system-icons@${{ steps.setup_config.outputs.git_ref_display }}  
          **ðŸ”§ Plugin:** fluent.icons v2.0.0  
          
          ### ðŸ“Š Summary
          - **ðŸ  Icon Families Added:** ${{ steps.check_icons.outputs.new_families_count }}
          - **ðŸŽ¨ Style Variants Added:** ${{ steps.check_icons.outputs.new_variants_count }}
          - **ðŸ”„ Conversion:** SVG â†’ ImageVector (svg2compose)
          - **ðŸ“ Organization:** Style-based directories
          - **ðŸŽ¯ Naming:** FluentIcons.Style.IconName pattern
          
          ### âœ¨ What's New
          This sync brings new FluentUI System Icons automatically converted to Jetpack Compose ImageVectors:
          
          - âœ… **Automated Git Integration:** Plugin clones microsoft/fluentui-system-icons directly
          - ðŸŽ¨ **SVG Conversion:** High-quality SVG â†’ ImageVector conversion using svg2compose
          - ðŸ“ **Smart Organization:** Icons sorted into `filled/`, `regular/`, `light/`, `color/` directories  
          - ðŸ·ï¸ **Consistent Naming:** PascalCase with proper LTR/RTL handling
          - ðŸ“ **Auto-Import Management:** IconList files updated automatically
          - ðŸŽ¯ **Size Optimization:** Smart 24pxâ†’20pxâ†’16pxâ†’28pxâ†’32px fallback per style
          
          ### ðŸ“‚ Generated Structure
          ```
          library/src/commonMain/kotlin/fluent/ui/system/icons/
          â”œâ”€â”€ filled/
          â”‚   â”œâ”€â”€ FluentIconName.kt
          â”‚   â”œâ”€â”€ FluentTaskListLtr.kt
          â”‚   â””â”€â”€ FluentTaskListRtl.kt
          â”œâ”€â”€ regular/
          â”‚   â”œâ”€â”€ FluentIconName.kt
          â”‚   â””â”€â”€ FluentTaskListLtr.kt
          â”œâ”€â”€ light/
          â”‚   â””â”€â”€ FluentIconName.kt
          â”œâ”€â”€ color/
          â”‚   â””â”€â”€ FluentTaskListLtr.kt
          â”œâ”€â”€ FilledIconList.kt        # Auto-updated
          â”œâ”€â”€ RegularIconList.kt       # Auto-updated
          â”œâ”€â”€ LightIconList.kt         # Auto-updated
          â””â”€â”€ ColorIconList.kt         # Auto-updated
          ```
          
          ### ðŸ” New Icons Preview
          
          ```
          ${{ env.CHECK_OUTPUT }}
          ```
          
          ### ðŸ“ˆ Coverage Analysis
          
          ```
          ${{ env.COVERAGE_ANALYSIS }}
          ```
          
          ### ðŸŽ¯ Sync Strategy
          1. **Git Integration:** Shallow clone from microsoft/fluentui-system-icons@${{ steps.setup_config.outputs.git_ref_formatted }}
          2. **Icon Discovery:** Scan metadata.json files in assets/ directory  
          3. **Style Collection:** Gather all available styles per icon family
          4. **Size Selection:** Prefer 24px, fallback per style independently
          5. **Conversion:** SVG â†’ ImageVector using svg2compose library
          6. **Organization:** Place in style directories with proper imports
          7. **Cleanup:** Automatic temporary file cleanup
          
          ### ðŸš€ Usage Examples
          ```kotlin
          import fluent.ui.system.icons.FluentIcons
          
          @Composable
          fun MyScreen() {
              // Individual icons
              Icon(FluentIcons.Filled.FluentNewIcon, contentDescription = "New Icon")
              Icon(FluentIcons.Regular.FluentTaskListLtr, contentDescription = "Task List LTR")
          
              // All icons of a style  
              val allFilledIcons = FluentIcons.Filled.All
              val allRegularIcons = FluentIcons.Regular.All
          }
          ```
          
          ### ðŸ”§ Technical Details
          - **Plugin ID:** `fluent.icons` 
          - **Plugin Version:** v2.0.0
          - **Conversion Library:** svg2compose v0.8.1
          - **Git Library:** JGit (shallow clones)
          - **Serialization:** Kotlinx.Serialization v1.6.2
          - **Architecture:** SOLID principles with clean separation
          
          ### ðŸŽ¨ Icon Patterns Supported
          - **Regular:** `ic_fluent_access_time_24_filled.svg` â†’ `FluentAccessTime.kt`
          - **LTR/RTL Pattern 1:** `ic_fluent_multiselect_ltr_24_filled.svg` â†’ `FluentMultiselectLtr.kt`
          - **LTR/RTL Pattern 2:** `ic_fluent_task_list_24_filled_ltr.svg` â†’ `FluentTaskListLtr.kt`
          
          ---
          
          ðŸ¤– **Auto-generated by:** `fluentui-icons-sync` workflow  
          ðŸ“… **Generated on:** ${{ steps.commit_msg.outputs.timestamp }}  
          ðŸ”— **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
          ðŸŽ¯ **Plugin:** fluent.icons with Git integration
        labels: |
          ðŸŽ¨ fluent-icons
          ðŸ¤– automation
          ðŸ“¦ enhancement
          ðŸ”„ sync
        assignees: ${{ github.actor }}
        reviewers: ${{ github.actor }}
    
    - name: ðŸ“Š Generate workflow summary
      run: |
        echo "## ðŸŽ¨ FluentUI Icons Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Results" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” **Icons Check:** âœ… Completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ¿ **Git Reference:** ${{ steps.setup_config.outputs.git_ref_display }} (${{ steps.setup_config.outputs.git_ref_formatted }})" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ  **New families:** ${{ steps.check_icons.outputs.new_families_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¨ **New variants:** ${{ steps.check_icons.outputs.new_variants_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”„ **Sync performed:** ${{ steps.sync_check.outputs.sync_performed }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.sync_check.outputs.sync_performed }}" == "true" ]; then
          if [ "${{ steps.create_pr.outputs.pull-request-number }}" != "" ]; then
            echo "- âœ… **PR Created:** #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”— **PR URL:** ${{ steps.create_pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **PR Creation:** Failed or no changes detected" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- â„¹ï¸ **No sync needed:** No new variants found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Plugin Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Plugin ID:** fluent.icons" >> $GITHUB_STEP_SUMMARY
        echo "- **Mode:** Git Repository (automatic shallow clones)" >> $GITHUB_STEP_SUMMARY
        echo "- **Architecture:** SOLID principles with clean separation" >> $GITHUB_STEP_SUMMARY
        echo "- **Conversion:** svg2compose â†’ ImageVector" >> $GITHUB_STEP_SUMMARY
        echo "- **Organization:** Style-based directory structure" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“… Workflow Details" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ• Triggered:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸƒ Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ‘¤ Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŒ¿ Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ’¬ Add comment for manual triggers
      if: github.event_name == 'workflow_dispatch' && steps.create_pr.outputs.pull-request-number != ''
      uses: peter-evans/create-or-update-comment@v4
      with:
        issue-number: ${{ steps.create_pr.outputs.pull-request-number }}
        body: |
          ðŸ”„ **Manual FluentUI sync triggered by @${{ github.actor }}**
          
          **Input Parameters:**
          - Force Sync: `${{ github.event.inputs.force_sync }}`
          - Git Reference: `${{ github.event.inputs.git_ref || 'main' }}` â†’ `${{ steps.setup_config.outputs.git_ref_formatted }}`
          - Custom Branch: `${{ github.event.inputs.custom_branch || 'auto-generated' }}`
          
          **Sync Results:**
          - New Families: ${{ steps.check_icons.outputs.new_families_count }}
          - New Variants: ${{ steps.check_icons.outputs.new_variants_count }}
          - Source: microsoft/fluentui-system-icons@${{ steps.setup_config.outputs.git_ref_display }}
          
          **Plugin Configuration:**
          - Plugin: fluent.icons v2.0.0
          - Mode: Git Repository (automatic shallow clones)
          - Conversion: SVG â†’ ImageVector
